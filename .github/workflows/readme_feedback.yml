name: Feedback for LLM-generated README updates

# Developer note: When triggered by a comment, Github Actions will run the workflow on main, not the PR branch

on:
  issue_comment:

jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      # - name: Exit if PR ref starts with update-your-readme
      #   if: !startsWith(github.event.pull_request.head.ref, 'update-your-readme')
      #   run: echo "PR ref starts with update-your-readme, exiting." && exit 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv
          pipenv install

      - name: Extract original PR
        shell: bash
        id: original-pr
        run: |
          ORIGINAL_PR=$(echo "${{ github.event.issue.title }}" | rev | cut -d" " -f1 | rev)
          echo "num=$ORIGINAL_PR" >> $GITHUB_OUTPUT
          ORIGINAL_PR_BRANCH=$(gh pr view $ORIGINAL_PR --json headRefName -q '.headRefName')
          echo "branch=$ORIGINAL_PR_BRANCH" >> $GITHUB_OUTPUT

      - name: Update README
        id: update-readme
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          pipenv run python src/core.py --repository ${{ github.repository }} --pr ${{ steps.original-pr.outputs.num }} --readme README.md --feedback "${{ github.event.comment.body }}" --output-format github >> $GITHUB_OUTPUT
          cat $GITHUB_OUTPUT

# Comment on the current PR with should_update and reason
      - name: Create comment
        uses: peter-evans/create-or-update-comment@v4
        if: steps.update-readme.outputs.should_update == 'True'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            Updating using feedback from ${{ github.event.comment.id }}.

            Reason:
            ${{ steps.update-readme.outputs.reason }}
      # - name: Extract branch name
      #   shell: bash
      #   run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
      #   id: extract_branch
      # - name: Get PR author
      #   id: pr-author
      #   run: |
      #     PR_AUTHOR=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")
      #     echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
      # - name: Create Pull Request
      #   uses: peter-evans/create-pull-request@v7
      #   id: cpr
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     commit-message: "Incorporate feedback from comment ${{ github.event.comment.id }}"
      #     title: "[Bot] README updates for PR ${{ github.event.issue.number }}"
      #     body: >
      #       This PR is auto-generated by
      #       [update-your-readme](https://github.com/ktrnka/update-your-readme).
      #       The README changes are generated based on the changes in PR ${{ github.event.issue.html_url }} and
      #       your existing README.
      #     labels: feature, automated pr
      #     branch: "update-your-readme-${{ github.event.issue.number }}"
      #     base: ${{ steps.extract_branch.outputs.branch }}
      #     reviewers: ${{ steps.pr-author.outputs.author }}
      # - name: Create comment
      #   uses: peter-evans/create-or-update-comment@v4
      #   if: steps.cpr.outputs.pull-request-url != ''
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     issue-number: ${{ github.event.issue.number }}
      #     body: |
      #       "Updated PR using feedback from ${{ github.event.comment.id }}"
