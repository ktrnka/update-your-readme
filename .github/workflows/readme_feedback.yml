name: Feedback for LLM-generated README updates

on:
  issue_comment:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv
          pipenv install
      - name: Update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: pipenv run python src/core.py --repository ${GITHUB_REPOSITORY} --pr ${{ github.event.issue.number }} --readme README.md --feedback "${{ github.event.comment.body }}"
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Get PR author
        id: pr-author
        run: |
          PR_AUTHOR=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        id: cpr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Incorporate feedback from comment ${{ github.event.comment.id }}"
          title: "[Bot] README updates for PR ${{ github.event.issue.number }}"
          body: >
            This PR is auto-generated by
            [update-your-readme](https://github.com/ktrnka/update-your-readme).
            The README changes are generated based on the changes in PR ${{ github.event.issue.html_url }} and
            your existing README.
          labels: feature, automated pr
          branch: "update-your-readme-${{ github.event.issue.number }}"
          base: ${{ steps.extract_branch.outputs.branch }}
          reviewers: ${{ steps.pr-author.outputs.author }}
      - name: Create comment
        uses: peter-evans/create-or-update-comment@v4
        if: steps.cpr.outputs.pull-request-url != ''
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            "Updated PR using feedback from ${{ github.event.comment.id }}"
